<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SAVE THE COW</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
:root{--accent:#ffd66b;--panel:#121212;--heart-img:url('img/corazones.png')}
*{margin:0;padding:0;box-sizing:border-box}
body{height:100vh;background:#584040;display:flex;align-items:center;justify-content:center}
.contenedor{width:920px;height:280px;position:relative;overflow:hidden;border-radius:12px;background:linear-gradient(#b7d6c7,transparent) #ffe2d1;transition:background-color 1s linear, background 1s linear;box-shadow:0 20px 40px rgba(0,0,0,.35);image-rendering:pixelated}
.mediodia{background-color:#ffdcf3}.tarde{background-color:#ffadad}.noche{background-color:#aca8c7}
.level-2{background:#000 !important}.level-3{background:#000 !important}
.score{position:absolute;top:10px;right:14px;z-index:20;color:#d48871;font:700 18px 'Press Start 2P',monospace}
.lives{position:absolute;top:10px;left:12px;height:28px;display:flex;gap:6px;z-index:20}
.life{width:28px;height:28px;background-image:var(--heart-img);background-repeat:no-repeat;background-size:300% 100%;opacity:1;transition:opacity .15s ease, transform .15s ease}
.life.lost{opacity:0;transform:scale(.9)}.heart-1{background-position:0% 0}.heart-2{background-position:50% 0}.heart-3{background-position:100% 0}
.suelo{width:200%;height:42px;position:absolute;bottom:0;left:0;background:url('img/suelo.png') repeat-x 0 0;background-size:50% 42px}
.dino{width:79px;height:84px;position:absolute;bottom:22px;left:42px;z-index:3;background-size:336px 90px;background-position-x:0}
.dino.cow{background-image:url('img/cow-test2.png')}
.dino.chicken{background-image:url('img/chicken-test1.png')}
.dino-corriendo{animation:animarDino .25s steps(2) infinite}.dino-estrellado{background-position-x:-252px}
@keyframes animarDino{from{background-position-x:-84px}to{background-position-x:-252px}}
.cactus{width:46px;height:81px;position:absolute;bottom:16px;left:600px;z-index:2;background:url('img/hacha.png') no-repeat}
.cactus2{width:98px;height:66px;background:url('img/hacha1.png') no-repeat}
.nube{width:92px;height:26px;position:absolute;z-index:0;background:url('img/nube.png') no-repeat;background-size:92px 26px}

/* UFO NIVEL 2 */
#ufoLayer{position:absolute;inset:0;pointer-events:none;display:none;z-index:1}
.level-2 #ufoLayer{display:block}
#ufoLayer img{position:absolute;width:130px;top:22px;left:-220px;animation:ufoMove 12s linear infinite, ufoBob 1.8s ease-in-out infinite;image-rendering:pixelated;opacity:.95;filter:drop-shadow(0 2px 0 rgba(0,0,0,.35))}
@keyframes ufoMove{0%{transform:translateX(-220px)}50%{transform:translateX(980px)}100%{transform:translateX(-220px)}}
@keyframes ufoBob{0%,100%{top:22px}50%{top:28px}}

/* Overlays */
.overlay{position:fixed;inset:0;width:100vw;height:100dvh;z-index:99999;display:none;align-items:center;justify-content:center;background:#0b0b0d}
.overlay.show{display:flex}
.overlay::before{content:"";position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient(to bottom, rgba(255,255,255,.03) 0, rgba(255,255,255,.03) 2px, transparent 2px, transparent 4px)}
.panel{position:relative;z-index:2;width:92%;max-width:780px;padding:22px;text-align:center;color:#eaeaea;background:var(--panel);border:4px solid #fff;outline:4px solid #000;box-shadow:inset 0 0 0 4px #444,0 12px 0 #000;border-radius:8px;font-family:'Press Start 2P',monospace;pointer-events:auto}
.title-xxl{font-size:26px;color:var(--accent);text-shadow:0 3px 0 #000;margin-bottom:10px}
.sub{font-size:12px;color:#cacaca;line-height:1.6;margin-bottom:14px}
.start-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin:12px 0}
.char{display:flex;align-items:center;gap:12px;padding:12px;background:#1f1f1f;border:3px solid #555;border-radius:8px;cursor:pointer;transition:transform .08s ease,border-color .08s ease}
.char:hover{transform:translateY(-2px);border-color:#9ad3ff}
.char-swatch{width:84px;height:90px;background-size:336px 90px;background-position-x:-84px}
.swatch-cow{background-image:url('img/cow-test2.png')}
.swatch-chicken{background-image:url('img/chicken-test1.png')}
.char-name{font-size:14px;color:#fff}.char-desc{font-size:10px;color:#a8a8a8;margin-top:6px;text-align:left}
.retro-btn{display:inline-block;padding:12px 18px;background:#2b2b2b;color:#fff;border:3px solid #fff;outline:3px solid #000;border-radius:8px;box-shadow:0 6px 0 #000;text-decoration:none;font-family:'Press Start 2P',monospace;font-size:12px;cursor:pointer}
.retro-btn:hover{transform:translateY(-1px)}.retro-btn:active{transform:translateY(2px);box-shadow:0 2px 0 #000}

.overlay--ingame{position:absolute;inset:0;z-index:80;display:none;align-items:center;justify-content:center;background:transparent;pointer-events:none}
.overlay--ingame.show{display:flex}
.life-lost-wrap{text-align:center;pointer-events:auto;font-family:'Press Start 2P',monospace}
.life-lost-msg{color:#fff;font-size:18px;margin-bottom:12px;text-shadow:0 2px 0 #000,0 0 8px rgba(0,0,0,.35)}
.retro-btn.green{background:#1d7e48;border:3px solid #e7ffe7;outline:3px solid #0e3b24;color:#fff;box-shadow:0 6px 0 #0e3b24}
.retro-btn.green:hover{transform:translateY(-1px)}.retro-btn.green:active{transform:translateY(2px);box-shadow:0 2px 0 #0e3b24}
.go-msg{color:#ff3b3b;font-size:20px;margin-bottom:12px;text-shadow:0 2px 0 #000,0 0 10px rgba(255,59,59,.45)}
.win-msg{color:#ffe46b;font-size:20px;margin-bottom:12px;text-shadow:0 2px 0 #000,0 0 10px rgba(255,228,107,.45)}

.level-overlay{position:absolute;inset:0;z-index:70;display:none;align-items:center;justify-content:center;background:transparent;pointer-events:none}
.level-overlay.show{display:flex}
.level-label{font-family:'Press Start 2P',monospace;font-size:18px;color:#fff;text-shadow:0 2px 0 #000,0 0 8px rgba(0,0,0,.4)}

/* Tormenta */
#rainLayer,#lightningLayer{position:absolute;inset:0;pointer-events:none;z-index:5;display:none}
.level-3 #rainLayer,.level-3 #lightningLayer{display:block}
.drop{position:absolute;top:-20px;width:2px;height:14px;background:rgba(180,200,255,.8);filter:blur(.2px);animation:fall linear infinite}
@keyframes fall{to{transform:translateY(320px)}}
.flash{position:absolute;inset:0;background:linear-gradient(#fff,rgba(255,255,255,.6) 40%, rgba(255,255,255,0) 60%);opacity:0;animation:flash 300ms ease-out;mix-blend-mode:screen}
@keyframes flash{0%{opacity:0}10%{opacity:.9}40%{opacity:.25}100%{opacity:0}}
  </style>
</head>
<body>

  <!-- SFX -->
  <audio id="hit-sfx" preload="auto" playsinline><source src="./music/estrellar.mp3" type="audio/mpeg"></audio>

  <!-- Juego -->
  <div class="contenedor" id="game">
    <div class="lives" id="lives"></div>
    <div class="score" id="score">000</div>

    <div class="suelo"></div>
    <div class="dino cow dino-corriendo" id="player"></div>

    <!-- UFO (solo NIVEL 2) -->
    <div id="ufoLayer"><img src="img/ufo2.gif" alt="UFO"></div>

    <!-- Tormenta -->
    <div id="rainLayer"></div>
    <div id="lightningLayer"></div>

    <!-- VIDA PERDIDA -->
    <div class="overlay--ingame" id="lifeLostOverlay">
      <div class="life-lost-wrap">
        <div class="life-lost-msg">¬°NO PUDISTE SALVARLA!</div>
        <button class="retro-btn green" id="retryBtn">REINTENTAR</button>
      </div>
    </div>

    <!-- GAME OVER -->
    <div class="overlay--ingame" id="gameOverOverlay">
      <div class="life-lost-wrap">
        <div class="go-msg">GAME OVER</div>
        <button class="retro-btn green" id="backToStart">VOLVER AL INICIO</button>
      </div>
    </div>

    <!-- WIN -->
    <div class="overlay--ingame" id="winOverlay">
      <div class="life-lost-wrap">
        <div class="win-msg">¬°GANASTE!</div>
        <button class="retro-btn green" id="backToStartWin">VOLVER AL INICIO</button>
      </div>
    </div>

    <!-- Banner de nivel -->
    <div class="level-overlay" id="levelOverlay">
      <div class="level-label" id="levelLabel">NIVEL 1</div>
    </div>
  </div>

  <!-- Portada -->
  <div class="overlay show" id="startOverlay" aria-hidden="false">
    <div class="panel">
      <div class="title-xxl">SAVE THE COW</div>
      <div class="sub">Eleg√≠ tu personaje. Salt√° con <b>clic</b>, <b>toque</b>, <b>Espacio</b> o <b>‚Üë</b>. Ten√©s <b>3 vidas</b>.</div>
      <div class="start-grid" id="charGrid">
        <div class="char" data-animal="cow" tabindex="0" role="button" aria-label="Elegir vaca">
          <div class="char-swatch swatch-cow"></div>
          <div>
            <div class="char-name">VACA</div>
            <div class="char-desc">Sprite original, paso firme üêÑ</div>
          </div>
        </div>
        <div class="char" data-animal="chicken" tabindex="0" role="button" aria-label="Elegir gallina">
          <div class="char-swatch swatch-chicken"></div>
          <div>
            <div class="char-name">GALLINA</div>
            <div class="char-desc">Ligera y saltarina üêî</div>
          </div>
        </div>
      </div>
      <a class="retro-btn" id="startDefault" tabindex="0" role="button" aria-label="Start vaca">START (VACA)</a>
    </div>
  </div>

<script>
/* ===== STATE / CONST ===== */
let time=new Date(), deltaTime=0;

const sueloY=22, impulso=900, gravedad=2500;
let velY=0, dinoPosY=sueloY;

const dinoPosX=42;
let sueloX=0, gameVel=1, score=0;
const velEscenarioBase=1280/3;

let parado=false, saltando=false, selectedAnimal='cow';

let tiempoHastaObstaculo=2;
const tiempoObstaculoMin=0.7, tiempoObstaculoMax=1.8;
let obstaculos=[];

let tiempoHastaNube=0.5, tiempoNubeVar=0.5;
const tiempoNubeMin=0.7, tiempoNubeMax=2.7, maxNubeY=270, minNubeY=100;
let nubes=[], velNube=0.5;

const MAX_LIVES=3;
let lives=MAX_LIVES;

let level=1;                 // 1,2,3
let levelSpeedFactor=1;

let contenedor,dino,textoScore,suelo,startOverlay,lifeLostOverlay,gameOverOverlay,winOverlay,livesHud;
let levelOverlay,levelLabel, rainLayer, lightningLayer;

/* ===== AUDIO (WebAudio) ===== */
let audioCtx=null, hitBuffer=null, sfxPrimed=false, audioUnlocked=false;

function ensureAudioCtx(){
  if(!audioCtx){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    audioCtx = new Ctx();
  }
  return audioCtx;
}

/* --- ‚Äúpulso‚Äù inaudible para iOS --- */
function userUnlockPulse(){
  try{
    const ctx = ensureAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    gain.gain.value = 0.0001; // inaudible
    osc.connect(gain).connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.03);
  }catch(e){}
}

/* --- BGM manager --- */
const BGM_SRC = { 1:'./music/fondoMusic.mp3', 2:'./music/level2.mp3', 3:'./music/level3.mp3' };
const BGM = {
  buffers: new Map(),
  currentLevel: null,
  source: null,
  gain: null,

  async load(level){
    if(this.buffers.has(level)) return this.buffers.get(level);
    const res = await fetch(BGM_SRC[level]);
    const arr = await res.arrayBuffer();
    const buf = await ensureAudioCtx().decodeAudioData(arr);
    this.buffers.set(level, buf);
    return buf;
  },

  stop(){
    if(this.source){ try{ this.source.stop(0); }catch(e){} try{ this.source.disconnect(); }catch(e){} this.source=null; }
    if(this.gain){ try{ this.gain.disconnect(); }catch(e){} this.gain=null; }
  },

  async play(level, reset=false){
    const ctx = ensureAudioCtx();
    if(ctx.state === 'suspended'){ try{ await ctx.resume(); }catch(e){} }

    if(this.currentLevel===level && this.source && !reset) return;

    const buf = await this.load(level);
    this.stop();

    this.gain = ctx.createGain();
    this.gain.gain.value = 1;

    this.source = ctx.createBufferSource();
    this.source.buffer = buf;
    this.source.loop = true;
    this.source.connect(this.gain).connect(ctx.destination);
    this.source.start(0);

    this.currentLevel = level;
  }
};

/* SFX */
const hitEl= ()=>document.getElementById("hit-sfx");
async function loadHitBuffer(){
  try{
    const r = await fetch('./music/estrellar.mp3');
    const b = await r.arrayBuffer();
    hitBuffer = await ensureAudioCtx().decodeAudioData(b);
  }catch(e){}
}
function playHit(){
  if(hitBuffer && audioCtx){
    try{
      const src = audioCtx.createBufferSource();
      src.buffer = hitBuffer;
      src.connect(audioCtx.destination);
      src.start(0);
      return;
    }catch(e){}
  }
  const s = hitEl(); if(s){ s.currentTime=0; s.play().catch(()=>{}); }
}

/* ===== INPUT HELPERS ===== */
function bindInteractive(el, handler){
  if(!el) return;
  el.addEventListener('click', (e)=>{e.preventDefault(); handler(e);});
  el.addEventListener('pointerdown', (e)=>{e.preventDefault(); handler(e);}, {passive:false});
  el.addEventListener('touchstart', (e)=>{e.preventDefault(); handler(e);}, {passive:false});
  el.addEventListener('keydown', (e)=>{ if(e.code==='Space'||e.code==='Enter'){ e.preventDefault(); handler(e); }});
}

/* ===== BOOT ===== */
if(document.readyState==="complete"||document.readyState==="interactive"){setTimeout(init,1)} else {document.addEventListener("DOMContentLoaded",init)}

function init(){
  contenedor=document.getElementById("game");
  dino=document.getElementById("player");
  textoScore=document.getElementById("score");
  suelo=document.querySelector(".suelo");
  startOverlay=document.getElementById("startOverlay");
  lifeLostOverlay=document.getElementById("lifeLostOverlay");
  gameOverOverlay=document.getElementById("gameOverOverlay");
  winOverlay=document.getElementById("winOverlay");
  levelOverlay=document.getElementById("levelOverlay");
  levelLabel=document.getElementById("levelLabel");
  livesHud=document.getElementById("lives");
  rainLayer=document.getElementById("rainLayer");
  lightningLayer=document.getElementById("lightningLayer");

  const grid=document.getElementById('charGrid');
  grid.querySelectorAll('.char').forEach(card=>{
    bindInteractive(card, ()=> startGame(card.getAttribute('data-animal')||'cow'));
  });
  bindInteractive(document.getElementById("startDefault"), ()=> startGame('cow'));

  bindInteractive(document.getElementById("retryBtn"), resumeAfterDeath);
  bindInteractive(document.getElementById("backToStart"), backToStart);
  bindInteractive(document.getElementById("backToStartWin"), backToStart);

  window.addEventListener("pointerdown", onPress, {passive:true});
  window.addEventListener("touchstart", onPress, {passive:true});
  window.addEventListener("keydown", onKeyDown, true);

  loadHitBuffer();
  Loop();
}

function Loop(){
  deltaTime=(new Date()-time)/1000; time=new Date();
  Update();
  requestAnimationFrame(Loop);
}

/* ===== AUDIO UNLOCK ===== */
function unlockAudioGestureThen(cb){
  try{
    const ctx = ensureAudioCtx();
    // pulso inaudible dentro del gesto
    userUnlockPulse();
    // reanudar y luego ejecutar callback (arrancar BGM)
    ctx.resume().then(()=>{
      audioUnlocked = true;
      if(typeof cb === 'function') cb();
    }).catch(()=>{
      if(typeof cb === 'function') cb(); // fallback
    });
  }catch(e){
    if(typeof cb === 'function') cb();
  }
}

/* ===== FLUJO ===== */
function startGame(animal='cow'){
  // DESBLOQUEA audio en el mismo gesto del bot√≥n START y luego arranca BGM L1
  unlockAudioGestureThen(()=>{ BGM.play(1, true); });

  selectedAnimal=animal;
  level=1;
  levelSpeedFactor=1;
  contenedor.classList.remove('level-2','level-3','mediodia','tarde','noche');
  document.getElementById('ufoLayer').style.display='none';
  stopStorm();
  resetAll(true);
  applyCharacter();
  hideStart();
  showLevelBanner('NIVEL 1');
}

function backToStart(){
  BGM.stop();
  showStart();
}

function showStart(){
  resetAll(true);
  startOverlay.classList.add("show");
  lifeLostOverlay.classList.remove("show");
  gameOverOverlay.classList.remove("show");
  winOverlay.classList.remove("show");
  levelOverlay.classList.remove("show");
  stopStorm();
}

function hideStart(){
  startOverlay.classList.remove("show");
  if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
}

/* ===== RESET ===== */
function resetAll(full=false){
  sueloX=0; dinoPosY=sueloY; velY=0; gameVel=1*levelSpeedFactor;
  obstaculos.forEach(o=>o.remove()); nubes.forEach(n=>n.remove());
  obstaculos=[]; nubes=[];
  dino.classList.remove("dino-estrellado");
  if(!dino.classList.contains("dino-corriendo")) dino.classList.add("dino-corriendo");
  parado=false; saltando=false;
  if(full){ score=0; textoScore.textContent="000"; lives=MAX_LIVES; }
  renderLives();
}

function applyCharacter(){
  dino.classList.remove("cow","chicken");
  dino.classList.add(selectedAnimal);
}

/* ===== UPDATE ===== */
function Update(){
  if(parado || startOverlay.classList.contains("show") || lifeLostOverlay.classList.contains("show") || gameOverOverlay.classList.contains("show") || winOverlay.classList.contains("show") || levelOverlay.classList.contains("show")) return;

  moverDinosaurio();
  moverSuelo();
  decidirCrearObstaculos();
  decidirCrearNubes();
  moverObstaculos();
  moverNubes();
  detectarColision();
  velY -= gravedad * deltaTime;

  if(level===1 && score>=70){ toLevel2(); }
  else if(level===2 && score>=110){ toLevel3(); }
  else if(level===3 && score>=150){ onWin(); }
}

/* ===== INPUT ===== */
function onPress(){
  // Por si alguien salta sin pasar por START (gesto igualmente desbloquea)
  if(!audioUnlocked) unlockAudioGestureThen(()=>{ if(!BGM.source) BGM.play(level, false); });

  if(startOverlay.classList.contains("show")) return;
  if(lifeLostOverlay.classList.contains("show")){ resumeAfterDeath(); return; }
  if(gameOverOverlay.classList.contains("show") || winOverlay.classList.contains("show")){ backToStart(); return; }
  if(levelOverlay.classList.contains("show")) return;

  if(!BGM.source) BGM.play(level, false);
  saltar();
}
function onKeyDown(e){
  const isSpace = e.code==="Space" || e.key===" " || e.keyCode===32;
  const isArrowUp = e.code==="ArrowUp" || e.keyCode===38;
  if(startOverlay.classList.contains('show') && (e.code==='Enter'||isSpace)){
    e.preventDefault(); startGame('cow'); return;
  }
  if(isSpace||isArrowUp){
    e.preventDefault();
    onPress();
  }
}

/* ===== F√çSICA ===== */
function saltar(){ if(dinoPosY===sueloY){ saltando=true; velY=impulso; dino.classList.remove("dino-corriendo"); } }
function moverDinosaurio(){ dinoPosY += velY * deltaTime; if(dinoPosY<sueloY) tocarSuelo(); dino.style.bottom = dinoPosY + "px"; }
function tocarSuelo(){ dinoPosY=sueloY; velY=0; if(saltando) dino.classList.add("dino-corriendo"); saltando=false; }
function moverSuelo(){ sueloX += velEscenarioBase * deltaTime * gameVel; suelo.style.left = -(sueloX % contenedor.clientWidth) + "px"; }

/* ===== SPAWN ===== */
function decidirCrearObstaculos(){ tiempoHastaObstaculo -= deltaTime; if(tiempoHastaObstaculo<=0) crearObstaculo(); }
function decidirCrearNubes(){ tiempoNubeVar -= deltaTime; if(tiempoNubeVar<=0) crearNube(); }
function crearObstaculo(){
  const o=document.createElement("div");
  contenedor.appendChild(o);
  o.classList.add("cactus");
  if(Math.random()>0.5) o.classList.add("cactus2");
  o.posX=contenedor.clientWidth;
  o.style.left=contenedor.clientWidth+"px";
  obstaculos.push(o);
  tiempoHastaObstaculo = tiempoObstaculoMin + Math.random()*(tiempoObstaculoMax-tiempoObstaculoMin)/gameVel;
}
function crearNube(){
  const n=document.createElement("div");
  contenedor.appendChild(n);
  n.classList.add("nube");
  n.posX=contenedor.clientWidth;
  n.style.left=contenedor.clientWidth+"px";
  n.style.bottom=(minNubeY + Math.random()*(maxNubeY-minNubeY))+"px";
  nubes.push(n);
  tiempoNubeVar = tiempoNubeMin + Math.random()*(tiempoNubeMax-tiempoNubeMin)/gameVel;
}

/* ===== MOVE ===== */
function moverObstaculos(){
  for(let i=obstaculos.length-1;i>=0;i--){
    if(obstaculos[i].posX < -obstaculos[i].clientWidth){
      obstaculos[i].remove(); obstaculos.splice(i,1); ganarPuntos();
    }else{
      obstaculos[i].posX -= velEscenarioBase * deltaTime * gameVel;
      obstaculos[i].style.left = obstaculos[i].posX + "px";
    }
  }
}
function moverNubes(){
  for(let i=nubes.length-1;i>=0;i--){
    if(nubes[i].posX < -nubes[i].clientWidth){
      nubes[i].remove(); nubes.splice(i,1);
    }else{
      nubes[i].posX -= velEscenarioBase * deltaTime * gameVel * velNube;
      nubes[i].style.left = nubes[i].posX + "px";
    }
  }
}

/* ===== SCORE / DIFICULTAD ===== */
function ganarPuntos(){
  score++; textoScore.textContent = String(score).padStart(3,'0');
  if(level===1){
    if(score===5){ gameVel=1.5*levelSpeedFactor; contenedor.classList.add("mediodia"); }
    else if(score===10){ gameVel=2*levelSpeedFactor; contenedor.classList.add("tarde"); }
    else if(score===20){ gameVel=3*levelSpeedFactor; contenedor.classList.add("noche"); }
  }
  suelo.style.animationDuration=(3/gameVel)+"s";
}

/* ===== COLISI√ìN / VIDAS ===== */
function detectarColision(){
  for(let i=0;i<obstaculos.length;i++){
    if(obstaculos[i].posX > dinoPosX + dino.clientWidth) break;
    if(isCollision(dino,obstaculos[i],10,30,15,20)){ onDeath(); break; }
  }
}
function onDeath(){
  dino.classList.remove("dino-corriendo");
  dino.classList.add("dino-estrellado");
  parado = true;
  playHit();
  // Mant√©n la BGM sonando; si quisieras pausarla, usa BGM.stop();
  lives--; renderLives();
  if(lives<=0){ showGameOver(); }
  else{ lifeLostOverlay.classList.add("show"); }
}
function resumeAfterDeath(){
  lifeLostOverlay.classList.remove("show");
  obstaculos.forEach(o=>o.remove()); obstaculos=[];
  nubes.forEach(n=>n.remove()); nubes=[];
  dino.classList.remove("dino-estrellado");
  dino.classList.add("dino-corriendo");
  dinoPosY=sueloY; velY=0; parado=false;
  BGM.play(level, false);
}
function showGameOver(){ gameOverOverlay.classList.add("show"); /*BGM.stop();*/ }
function onWin(){ winOverlay.classList.add('show'); parado=true; /*BGM.stop();*/ }

function renderLives(){
  livesHud.innerHTML="";
  const frames=['heart-1','heart-2','heart-3'];
  for(let i=0;i<MAX_LIVES;i++){
    const span=document.createElement('span');
    span.className='life '+frames[i]+(i<lives?'':' lost');
    livesHud.appendChild(span);
  }
}

/* ===== NIVELES ===== */
function showLevelBanner(text){
  levelLabel.textContent=text;
  levelOverlay.classList.add('show');
  const prevParado = parado;
  parado = true;
  setTimeout(()=>{
    levelOverlay.classList.remove('show');
    parado = prevParado;
  }, 1300);
}

function toLevel2(){
  level=2;
  levelSpeedFactor = 1.6;
  contenedor.classList.add('level-2');
  contenedor.classList.remove('mediodia','tarde','noche');

  const ufoLayer=document.getElementById('ufoLayer');
  ufoLayer.style.display='block';
  const ufoImg = ufoLayer.querySelector('img');
  if(ufoImg){ ufoImg.src = 'img/ufo2.gif?t=' + Date.now(); }

  stopStorm();
  resetAll(false);
  score = 0; textoScore.textContent = "000";
  gameVel = 1.8 * levelSpeedFactor;
  showLevelBanner('NIVEL 2');

  BGM.play(2, true);
}

function toLevel3(){
  level = 3;
  levelSpeedFactor = 2.0;

  contenedor.classList.add('level-3');
  contenedor.classList.remove('level-2');

  document.getElementById('ufoLayer').style.display='none';

  startStorm();
  resetAll(false);
  score = 0; textoScore.textContent = "000";
  gameVel = 2.2 * levelSpeedFactor;
  showLevelBanner('NIVEL 3');

  BGM.play(3, true);
}

/* ===== TORMENTA ===== */
let lightningTimer=null;
function startStorm(){
  rainLayer.innerHTML='';
  const W = contenedor.clientWidth;
  const dropCount = 120;
  for(let i=0;i<dropCount;i++){
    const d = document.createElement('div');
    d.className='drop';
    const left = Math.random()*W;
    const delay = Math.random()*1000;
    const dur = 800 + Math.random()*900;
    d.style.left = left+'px';
    d.style.animationDuration = dur+'ms';
    d.style.animationDelay = delay+'ms';
    rainLayer.appendChild(d);
  }
  lightningLayer.innerHTML='';
  clearInterval(lightningTimer);
  lightningTimer = setInterval(()=>{
    if(Math.random()<0.35){
      const f = document.createElement('div');
      f.className='flash';
      lightningLayer.appendChild(f);
      setTimeout(()=>f.remove(), 320);
    }
  }, 600);
}
function stopStorm(){
  rainLayer.innerHTML='';
  lightningLayer.innerHTML='';
  clearInterval(lightningTimer);
  lightningTimer=null;
}

/* ===== UTIL ===== */
function isCollision(a,b,padT,padR,padB,padL){
  const ar=a.getBoundingClientRect(), br=b.getBoundingClientRect();
  return !(
    ((ar.top + ar.height - padB) < br.top) ||
    (ar.top + padT > (br.top + br.height)) ||
    ((ar.left + ar.width - padR) < br.left) ||
    (ar.left + padL > (br.left + br.width))
  );
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
