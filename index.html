<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SAVE THE ANIMAL</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
:root{--accent:#ffd66b;--panel:#121212;--heart-img:url('img/corazones.png')}
*{margin:0;padding:0;box-sizing:border-box}
body{height:100vh;background:#584040;display:flex;align-items:center;justify-content:center}
.contenedor{width:920px;height:280px;position:relative;overflow:hidden;border-radius:12px;background:linear-gradient(#b7d6c7,transparent) #ffe2d1;transition:background-color 1s linear, background 1s linear;box-shadow:0 20px 40px rgba(0,0,0,.35);image-rendering:pixelated}
.mediodia{background-color:#ffdcf3}.tarde{background-color:#ffadad}.noche{background-color:#aca8c7}
.level-2{background:#000 !important}.level-3{background:#000 !important}
.score{position:absolute;top:10px;right:14px;z-index:20;color:#d48871;font:700 18px 'Press Start 2P',monospace}

/* HUD izquierda (vidas + mini selector) */
.hud-left{position:absolute;top:8px;left:8px;display:flex;align-items:center;gap:10px;z-index:20}
.lives{height:28px;display:flex;gap:6px}
.life{width:28px;height:28px;background-image:var(--heart-img);background-repeat:no-repeat;background-size:300% 100%;opacity:1;transition:opacity .15s ease, transform .15s ease}
.life.lost{opacity:0;transform:scale(.9)}.heart-1{background-position:0% 0}.heart-2{background-position:50% 0}.heart-3{background-position:100% 0}

/* HUD centro (coins) */
.hud-center{position:absolute; top:8px; left:50%; transform:translateX(-50%); z-index:20; pointer-events:none;}
.coins-hud{font:700 16px 'Press Start 2P', monospace; color:#ffd66b; text-shadow:0 2px 0 #000, 0 0 8px rgba(0,0,0,.35);}

.suelo{width:200%;height:42px;position:absolute;bottom:0;left:0;background:url('img/suelo.png') repeat-x 0 0;background-size:50% 42px}
.dino{width:79px;height:84px;position:absolute;bottom:22px;left:42px;z-index:3;background-size:336px 90px;background-position-x:0}
.dino.cow{background-image:url('img/cow-test2.png')}
.dino.chicken{background-image:url('img/chicken-test1.png')}
.dino.pig{background-image:url('img/pig-test1.png')}
.dino-corriendo{animation:animarDino .25s steps(2) infinite}.dino-estrellado{background-position-x:-252px}
@keyframes animarDino{from{background-position-x:-84px}to{background-position-x:-252px}}
.cactus{width:46px;height:81px;position:absolute;bottom:16px;left:600px;z-index:2;background:url('img/hacha.png') no-repeat}
.cactus2{width:98px;height:66px;background:url('img/hacha1.png') no-repeat}
.nube{width:92px;height:26px;position:absolute;z-index:0;background:url('img/nube.png') no-repeat;background-size:92px 26px}

/* UFO NIVEL 2 */
#ufoLayer{position:absolute;inset:0;pointer-events:none;display:none;z-index:1}
.level-2 #ufoLayer{display:block}
#ufoLayer img{position:absolute;width:130px;top:22px;left:-220px;animation:ufoMove 12s linear infinite, ufoBob 1.8s ease-in-out infinite;image-rendering:pixelated;opacity:.95;filter:drop-shadow(0 2px 0 rgba(0,0,0,.35))}
@keyframes ufoMove{0%{transform:translateX(-220px)}50%{transform:translateX(980px)}100%{transform:translateX(-220px)}}
@keyframes ufoBob{0%,100%{top:22px}50%{top:28px}}

/* Overlays */
.overlay{position:fixed;inset:0;width:100vw;height:100dvh;z-index:99999;display:none;align-items:center;justify-content:center;background:#0b0b0d}
.overlay.show{display:flex}
.overlay::before{content:"";position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient(to bottom, rgba(255,255,255,.03) 0, rgba(255,255,255,.03) 2px, transparent 2px, transparent 4px)}
.panel{position:relative;z-index:2;width:92%;max-width:780px;padding:22px;text-align:center;color:#eaeaea;background:var(--panel);border:4px solid #fff;outline:4px solid #000;box-shadow:inset 0 0 0 4px #444,0 12px 0 #000;border-radius:8px;font-family:'Press Start 2P',monospace;pointer-events:auto}
.title-xxl{font-size:26px;color:--accent;text-shadow:0 3px 0 #000;margin-bottom:10px}
.sub{font-size:12px;color:#cacaca;line-height:1.6;margin-bottom:14px}
.start-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;margin:12px 0}
.char{display:flex;align-items:center;gap:12px;padding:12px;background:#1f1f1f;border:3px solid #555;border-radius:8px;cursor:pointer;transition:transform .08s ease,border-color .08s ease}
.char:hover{transform:translateY(-2px);border-color:#9ad3ff}
.char-name{font-size:14px;color:#fff}.char-desc{font-size:10px;color:#a8a8a8;margin-top:6px;text-align:left}
.retro-btn{display:inline-block;padding:12px 18px;background:#2b2b2b;color:#fff;border:3px solid #fff;outline:3px solid #000;border-radius:8px;box-shadow:0 6px 0 #000;text-decoration:none;font-family:'Press Start 2P',monospace;font-size:12px;cursor:pointer}
.retro-btn:hover { transform: translateY(-1px); }
.retro-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }

.overlay--ingame{position:absolute;inset:0;z-index:80;display:none;align-items:center;justify-content:center;background:transparent;pointer-events:none}
.overlay--ingame.show{display:flex}
.life-lost-wrap{text-align:center;pointer-events:auto;font-family:'Press Start 2P',monospace}
.life-lost-msg{color:#fff;font-size:18px;margin-bottom:12px;text-shadow:0 2px 0 #000,0 0 8px rgba(0,0,0,.35)}
.retro-btn.green{background:#1d7e48;border:3px solid #e7ffe7;outline:3px solid #0e3b24;color:#fff;box-shadow:0 6px 0 #0e3b24}
.retro-btn.green:hover{transform:translateY(-1px)}.retro-btn.green:active{transform:translateY(2px);box-shadow:0 2px 0 #0e3b24}
.go-msg{color:#ff3b3b;font-size:20px;margin-bottom:12px;text-shadow:0 2px 0 #000,0 0 10px rgba(255,59,59,.45)}
.win-msg{color:#ffe46b;font-size:20px;margin-bottom:12px;text-shadow:0 2px 0 #000,0 0 10px rgba(255,228,107,.45)}

/* Etiqueta de nivel */
.level-overlay{position:absolute;inset:0;z-index:70;display:none;align-items:center;justify-content:center;background:transparent;pointer-events:none}
.level-overlay.show{display:flex}
.level-label{font-family:'Press Start 2P',monospace;font-size:18px;color:#fff;text-shadow:0 2px 0 #000,0 0 8px rgba(0,0,0,.4)}

/* Tormenta */
#rainLayer,#lightningLayer{position:absolute;inset:0;pointer-events:none;z-index:5;display:none}
.level-3 #rainLayer,.level-3 #lightningLayer{display:block}
.drop{position:absolute;top:-20px;width:2px;height:14px;background:rgba(180,200,255,.8);filter:blur(.2px);animation:fall linear infinite}
@keyframes fall{to{transform:translateY(320px)}}
.flash{position:absolute;inset:0;background:linear-gradient(#fff,rgba(255,255,255,.6) 40%, rgba(255,255,255,0) 60%);opacity:0;animation:flash 300ms ease-out;mix-blend-mode:screen}
@keyframes flash{0%{opacity:0}10%{opacity:.9}40%{opacity:.25}100%{opacity:0}}

/* === MINI SELECTOR (ocupa el lugar de los corazones) === */
.mini-select{display:none;align-items:center;gap:6px}
.mini-select.show{display:flex}
.mini-label{font:10px 'Press Start 2P', monospace; color:#ffe; text-shadow:0 2px 0 #000}
.mini-btn{
  font:10px 'Press Start 2P', monospace;
  padding:4px 6px;
  background:#1f1f1f; color:#fff;
  border:2px solid #fff; outline:2px solid #000;
  border-radius:6px; cursor:pointer; box-shadow:0 3px 0 #000;
}
.mini-btn:hover{transform:translateY(-1px)}
.mini-btn:active{transform:translateY(1px); box-shadow:0 1px 0 #000}
.mini-btn.selected{outline-color:#9ad3ff;border-color:#9ad3ff}

/* === CONTADOR grande en Game Over === */
.go-continue{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:8px}
.go-label{font:12px 'Press Start 2P', monospace; color:#ffe; text-shadow:0 2px 0 #000}
.go-count #countdown{
  display:block; font:700 56px 'Press Start 2P', monospace; line-height:1;
  color:#ffe46b; text-shadow:0 3px 0 #000, 0 0 14px rgba(255,228,107,.45);
  animation:pop 1s infinite steps(1);
}
@keyframes pop{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

/* === STORY/CONTEXT SCREEN (solo 1) === */
.context-title{color:#ffe46b;text-shadow:0 3px 0 #000;font-size:22px;margin-bottom:12px}
.video-strip{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.video-strip video{width:100%;aspect-ratio:16/9;border-radius:8px;border:3px solid #fff;outline:3px solid #000;box-shadow:0 6px 0 #000}
.context-text{font:12px 'Press Start 2P', monospace;color:#ddd;text-align:left;line-height:1.7}
.context-actions{display:flex;gap:12px;justify-content:center;margin-top:14px}
@media (max-width:760px){ .video-strip{grid-template-columns:1fr} }

/* Panel a pantalla completa, seguro en iOS/Android */
.context-full{
  width:100vw;
  height:100svh;                   /* usa el viewport visible en m√≥viles */
  height:100dvh;                   /* fallback moderno */
  max-width:none;
  border-radius:0;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:hidden;                 /* el scroll va en el body interno */
}

/* Cuerpo que puede scrollear si no alcanza la altura */
.context-body{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:auto;                   /* nunca se corta contenido */
}

/* 3 videos SIEMPRE en una sola fila (como web) */
.video-strip{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:12px;
  align-items:stretch;
}

/* Videos responsivos: mantienen 16:9 y recortan sin deformar */
.video-strip video{
  width:100%;
  aspect-ratio:16 / 9;
  height:auto;                     /* lo maneja aspect-ratio */
  object-fit:cover;
  border-radius:8px;
  border:3px solid #fff;
  outline:3px solid #000;
  box-shadow:0 6px 0 #000;
}

/* Texto con scroll si hace falta */
.context-text{
  font:12px 'Press Start 2P', monospace;
  color:#ddd;
  line-height:1.7;
  text-align:left;
}

/* Botones siempre visibles al borde inferior */
.context-actions{
  display:flex;
  gap:12px;
  justify-content:center;
  position:sticky;
  bottom:0;
  padding-top:8px;
  /* leve degrad√© para separar si hay scroll */
  background: linear-gradient(to top, rgba(18,18,18,.95), rgba(18,18,18,.6) 14%, transparent);
}

/* Ajustes finos cuando la altura es muy baja (landscape chico) */
@media (orientation: landscape) and (max-height: 480px){
  .context-full{ padding:10px; gap:8px; }
  .video-strip{ gap:8px; }
  .context-actions{ padding-top:6px; }
}
  </style>
</head>
<body>

  <!-- BGM √öNICA -->
  <audio id="bgm" preload="auto" loop playsinline></audio> 

  <!-- SFX -->
  <audio id="hit-sfx" preload="auto" playsinline>
    <source src="./music/estrellar.mp3" type="audio/mpeg">
  </audio>

  <!-- Juego -->
  <div class="contenedor" id="game">
    <div class="hud-left">
      <div class="lives" id="lives"></div>
      <div class="mini-select" id="miniSelect" aria-label="Elegir personaje">
        <div class="mini-label">ELIGIR:</div>
        <button class="mini-btn" data-mini="cow" title="Vaca">üêÑ VACA</button>
        <button class="mini-btn" data-mini="chicken" title="Gallina">üêî GALLINA</button>
        <button class="mini-btn" data-mini="pig" title="Cerdo">üê∑ CERDO</button>
      </div>
    </div>

    <!-- HUD centro: COINS -->
    <div class="hud-center" id="hudCenter">
      <div class="coins-hud">COINS: <span id="coinsHud">0</span></div>
    </div>

    <div class="score" id="score">000</div>

    <div class="suelo"></div>
    <div class="dino cow dino-corriendo" id="player"></div>

    <div id="ufoLayer"><img src="img/ufo2.gif" alt="UFO"></div>

    <div id="rainLayer"></div>
    <div id="lightningLayer"></div>

    <div class="overlay--ingame" id="lifeLostOverlay">
      <div class="life-lost-wrap">
        <div class="life-lost-msg">¬°NO PUDISTE SALVARLA!</div>
        <button class="retro-btn green" id="retryBtn">REINTENTAR</button>
      </div>
    </div>

    <!-- GAME OVER -->
    <div class="overlay--ingame" id="gameOverOverlay">
      <div class="life-lost-wrap">
        <div class="go-msg">GAME OVER</div>
        <div class="go-continue">
          <div class="go-label">CONTINUE? CHOOSE ANIMAL + INSERT COIN [C]</div>
          <div class="go-count"><span id="countdown">10</span></div>
        </div>
        <button class="retro-btn green" id="restartBtn" type="button">RESTART</button>
        <button class="retro-btn green" id="insertCoinBtn" type="button">INSERT COIN</button>
      </div>
    </div>

    <div class="overlay--ingame" id="winOverlay">
      <div class="life-lost-wrap">
        <div class="win-msg">¬°GANASTE!</div>
        <button class="retro-btn green" id="backToStartWin">VOLVER AL INICIO</button>
      </div>
    </div>

    <div class="level-overlay" id="levelOverlay">
      <div class="level-label" id="levelLabel">NIVEL 1</div>
    </div>
  </div>

  <!-- PANTALLA 1: BOOT -->
  <div class="overlay show" id="bootOverlay" aria-hidden="false">
    <div class="panel">
      <div class="title-xxl" style="color: yellow !important;">ZONA ANIMAL</div>
      <div class="sub">
        Presion√° <b>START</b> para jugar (luego eleg√≠s tu personaje).<br/>
        Pod√©s cargar <b>coins</b> ahora: clic en <b>INSERT COIN</b> o tecla <b>C</b>.
      </div>
      <div class="sub" style="margin-bottom:10px;">COINS: <span id="coinsBoot">0</span></div>
      <div style="display:flex;gap:12px;justify-content:center;margin-bottom:12px;">
        <a class="retro-btn green" id="goToSelect" tabindex="0" role="button" aria-label="Ir a historia">START</a>
        <a class="retro-btn" id="insertCoinBoot" role="button">INSERT COIN</a>
      </div>
      <div class="sub" style="margin-top:6px">Atajos: <b>Enter/Space</b> = START, <b>C</b> = coin</div>
    </div>
  </div>

  <!-- CONTEXTO (√∫nica) -->
 <div class="overlay" id="contextOverlay1" aria-hidden="true">
  <div class="panel context-full">
    <div class="context-title">PR√ìLOGO</div>

    <!-- NUEVO: cuerpo que puede scrollear -->
    <div class="context-body">
      <div class="video-strip">
        <video class="ctxvid" muted playsinline autoplay loop preload="auto">
          <source src="./video/cargando1.mp4" type="video/mp4">
        </video>
        <video class="ctxvid" muted playsinline autoplay loop preload="auto">
          <source src="./video/cargando2.mp4" type="video/mp4">
        </video>
        <video class="ctxvid" muted playsinline autoplay loop preload="auto">
          <source src="./video/cargando3.mp4" type="video/mp4">
        </video>
      </div>

      <div class="context-text">

      <div class="context-text">
        En un futuro no muy lejano, los avances tecnologicos han permitido a la humanidad total autonomia sobre su alimentacion.
        Por un modico precio usted puede adquirir su propio animal y consumirlo a gusto.
         Se recomienda siempre reservar un espacio de su casa que sirva de "Zona animal" como estacion de recarga, al finalizar podra volver a conectarselo.
          Recuerde: el animal le pertenece y esta totalmente domesticado, aunque ¬°A VECES ALGUNO LOGRA ESCAPAR!
      </div>

      <div class="context-actions">
      <a class="retro-btn green" id="ctx1Continue">CONTINUAR</a>
    </div>
    </div>
  </div>

  <!-- PANTALLA 2: SELECCI√ìN DE PERSONAJE -->
  <div class="overlay" id="selectOverlay" aria-hidden="true">
    <div class="panel">
      <div class="title-xxl" style="color: yellow !important;">ELEG√ç TU PERSONAJE</div>
      <div class="sub">Salt√°  <b>tocando la pantalla</b>, Ten√©s <b>3 vidas</b>. DEBES SALVAR <b>AL ANIMAL</b> Y AYUDARLO A ESCAPAR.</div>

      <div class="start-grid" id="charGrid">
        <div class="char" data-animal="cow" tabindex="0" role="button" aria-label="Elegir vaca">       
          <div>
            <div class="char-name">üêÑ VACA</div>
            <div class="char-desc">Hermosa y de paso firme</div>
          </div>
        </div>
        <div class="char" data-animal="chicken" tabindex="0" role="button" aria-label="Elegir gallina">        
          <div>
            <div class="char-name">üêî GALLINA</div>
            <div class="char-desc">Ligera y saltarina</div>
          </div>
        </div>
        <div class="char" data-animal="pig" tabindex="0" role="button" aria-label="Elegir cerdo">
          <div>
            <div class="char-name">üê∑ CERDO</div>
            <div class="char-desc">Compacto, actitud punk</div>
          </div>
        </div>
      </div>

      <a class="retro-btn green" id="startDefault" tabindex="0" role="button" aria-label="Start por defecto">JUGAR</a>
      
    </div>
  </div>

<script>
/* ===== STATE / CONST ===== */
let time=new Date(), deltaTime=0;

const sueloY=22, impulso=900, gravedad=2500;
let velY=0, dinoPosY=sueloY;

const dinoPosX=42;
let sueloX=0, gameVel=1, score=0;
const velEscenarioBase=1280/3;

let parado=false, saltando=false, selectedAnimal='cow';

let tiempoHastaObstaculo=2;
const tiempoObstaculoMin=0.7, tiempoObstaculoMax=1.8;
let obstaculos=[];

let tiempoHastaNube=0.5, tiempoNubeVar=0.5;
const tiempoNubeMin=0.7, tiempoNubeMax=2.7, maxNubeY=270, minNubeY=100;
let nubes=[], velNube=0.5;

const MAX_LIVES=3;
let lives=MAX_LIVES;

let level=1;                 // 1,2,3
let levelSpeedFactor=1;

let contenedor,dino,textoScore,suelo,bootOverlay,selectOverlay,lifeLostOverlay,gameOverOverlay,winOverlay,livesHud;
let levelOverlay,levelLabel, rainLayer, lightningLayer;

let credits=0;
const CREDIT_LIVES = MAX_LIVES;
let countdown=10, countdownId=null;

let deathY=sueloY;
let invulnerableUntil=0;

let pendingChoiceAnimal=null;

/* ===== AUDIO ===== */
const BGM_SRC = { 1:'./music/fondoMusic.mp3', 2:'./music/level2.mp3', 3:'./music/level3.mp3' };
const bgm = ()=>document.getElementById('bgm');
let audioUnlocked=false;
let pendingBGM=null;

function setBgmSrcForLevel(lvl){
  const a = bgm();
  const want = BGM_SRC[lvl];
  if(!a.src || !a.src.includes(want)){
    a.src = want;
    try{ a.load(); }catch(e){}
  }
}
function playBGM(lvl,{reset=false, fromGesture=false}={}){
  const a = bgm(); if(!a) return;
  setBgmSrcForLevel(lvl);
  if(reset){ try{ a.currentTime=0; }catch(e){} }
  const p = a.play();
  if(p && typeof p.catch==='function'){
    p.catch(()=>{ if(!fromGesture) pendingBGM = {lvl, reset:true}; });
  }
}
function tryPlayPendingBGM(){
  if(!pendingBGM) return;
  const {lvl, reset} = pendingBGM;
  pendingBGM = null;
  playBGM(lvl,{reset, fromGesture:true});
}
function unlockAudioNow(){
  if(audioUnlocked) return;
  const a = bgm(); if(!a) return;
  try{
    a.muted = true;
    if(!a.src) setBgmSrcForLevel(1);
    const p = a.play();
    if(p && typeof p.then==='function'){
      p.then(()=>{ a.pause(); try{ a.currentTime=0; }catch(e){}; a.muted=false; audioUnlocked=true; })
       .catch(()=>{ a.muted=false; });
    }else{ a.pause(); a.muted=false; audioUnlocked=true; }
  }catch(e){ a.muted=false; }
}

/* ===== INPUT HELPERS ===== */
function bindInteractive(el, handler){
  if(!el) return;
  el.addEventListener('click', (e)=>{e.preventDefault(); handler(e);});
  el.addEventListener('pointerdown', (e)=>{e.preventDefault(); handler(e);}, {passive:false});
  el.addEventListener('touchstart', (e)=>{e.preventDefault(); handler(e);}, {passive:false});
  el.addEventListener('keydown', (e)=>{ if(e.code==='Space'||e.code==='Enter'){ e.preventDefault(); handler(e); }});
}

/* ===== BOOT ===== */
if(document.readyState==="complete"||document.readyState==="interactive"){setTimeout(init,1)} else {document.addEventListener("DOMContentLoaded",init)}

function init(){
  contenedor=document.getElementById("game");
  dino=document.getElementById("player");
  textoScore=document.getElementById("score");
  suelo=document.querySelector(".suelo");

  bootOverlay=document.getElementById("bootOverlay");
  selectOverlay=document.getElementById("selectOverlay");
  lifeLostOverlay=document.getElementById("lifeLostOverlay");
  gameOverOverlay=document.getElementById("gameOverOverlay");
  winOverlay=document.getElementById("winOverlay");
  levelOverlay=document.getElementById("levelOverlay");
  levelLabel=document.getElementById("levelLabel");
  livesHud=document.getElementById("lives");
  rainLayer=document.getElementById("rainLayer");
  lightningLayer=document.getElementById("lightningLayer");

  // ===== Botones BOOT
  bindInteractive(document.getElementById("goToSelect"), ()=> showContext1());
  bindInteractive(document.getElementById("insertCoinBoot"), ()=>{ insertCoin(); refreshBootCoins(); });

  // ===== Pantalla Contexto (√∫nica)
  bindInteractive(document.getElementById("ctx1Continue"), ()=> showSelect());
  bindInteractive(document.getElementById("ctx1Skip"), ()=> showSelect());

  // ===== Selecci√≥n de personaje
  const grid=document.getElementById('charGrid');
  let tempSelection = 'cow';
  grid.querySelectorAll('.char').forEach(card=>{
    card.addEventListener('click', ()=>{
      tempSelection = card.getAttribute('data-animal')||'cow';
      grid.querySelectorAll('.char').forEach(c=>c.style.borderColor='#555');
      card.style.borderColor = '#9ad3ff';
    });
  });
  bindInteractive(document.getElementById("startDefault"), ()=>{ startGame(tempSelection); });

  // ===== In-game overlays
  bindInteractive(document.getElementById("retryBtn"), resumeAfterDeath);
  bindInteractive(document.getElementById("backToStartWin"), backToBoot);

  // ===== GAME OVER
  bindInteractive(document.getElementById('restartBtn'), onRestartChoose);
  bindInteractive(document.getElementById('insertCoinBtn'), ()=>{
    insertCoin();                 // suma coins ilimitadas
    tryAutoContinue();            // si ya hay animal elegido, contin√∫a al toque
  });

  // MINI SELECTOR clics (independientes del coin)
  document.querySelectorAll('#miniSelect [data-mini]').forEach(el=>{
    el.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      chooseMini(el.getAttribute('data-mini'));
    });
  });

  // Inputs globales
  window.addEventListener("pointerdown", ()=>{ tryPlayPendingBGM(); onPress(); }, {passive:true});
  window.addEventListener("touchstart",  ()=>{ tryPlayPendingBGM(); onPress(); }, {passive:true});
  window.addEventListener("keydown", onKeyDown, true);

  // Inicializar HUD coins
  updateCredits(); refreshBootCoins();

  Loop();
}

function Loop(){
  deltaTime=(new Date()-time)/1000; time=new Date();
  Update();
  requestAnimationFrame(Loop);
}

/* ===== PANTALLAS / CONTEXTO ===== */
function showBoot(){
  document.getElementById('bootOverlay').classList.add("show");
  document.getElementById('contextOverlay1').classList.remove("show");
  selectOverlay.classList.remove("show");
  lifeLostOverlay.classList.remove("show");
  gameOverOverlay.classList.remove("show");
  winOverlay.classList.remove("show");
  levelOverlay.classList.remove("show");
  stopStorm();
  hideMiniSelect();
  refreshBootCoins();
}

function showContext1(){
  document.getElementById('bootOverlay').classList.remove("show");
  document.getElementById('contextOverlay1').classList.add("show");
}

function showSelect(){
  document.getElementById('contextOverlay1').classList.remove("show");
  selectOverlay.classList.add("show");
  unlockAudioNow();
}

function hideSelect(){
  selectOverlay.classList.remove("show");
  if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
}

/* ===== FLUJO ===== */
function startGame(animal='cow'){
  playBGM(1,{reset:true, fromGesture:true});
  selectedAnimal=animal;
  level=1; levelSpeedFactor=1;
  contenedor.classList.remove('level-2','level-3','mediodia','tarde','noche');
  document.getElementById('ufoLayer').style.display='none';
  stopStorm();
  resetAll(true);
  applyCharacter();
  hideSelect();
  showLevelBanner('NIVEL 1');
}

function backToBoot(){
  const a=bgm(); if(a){ a.pause(); try{a.currentTime=0;}catch(e){} }
  showBoot();
  resetAll(true);
}

/* ===== RESET ===== */
function resetAll(full=false){
  sueloX=0; dinoPosY=sueloY; velY=0; gameVel=1*levelSpeedFactor;
  obstaculos.forEach(o=>o.remove()); nubes.forEach(n=>n.remove());
  obstaculos=[]; nubes=[];
  dino.classList.remove("dino-estrellado");
  if(!dino.classList.contains("dino-corriendo")) dino.classList.add("dino-corriendo");
  parado=false; saltando=false;
  if(full){ score=0; textoScore.textContent="000"; lives=MAX_LIVES; }
  renderLives();
  hideMiniSelect();
}

function applyCharacter(){
  dino.classList.remove("cow","chicken","pig");
  dino.classList.add(selectedAnimal);
}

/* ===== UPDATE ===== */
function Update(){
  if(
    parado ||
    document.getElementById('bootOverlay').classList.contains("show") ||
    document.getElementById('contextOverlay1').classList.contains("show") ||
    selectOverlay.classList.contains("show") ||
    lifeLostOverlay.classList.contains("show") ||
    gameOverOverlay.classList.contains("show") ||
    winOverlay.classList.contains("show") ||
    levelOverlay.classList.contains("show")
  ) return;

  moverDinosaurio(); moverSuelo();
  decidirCrearObstaculos(); decidirCrearNubes();
  moverObstaculos(); moverNubes();
  detectarColision();
  velY -= gravedad * deltaTime;

  if(level===1 && score>=70){ toLevel2(); }
  else if(level===2 && score>=110){ toLevel3(); }
  else if(level===3 && score>=150){ onWin(); }
}

/* ===== INPUT ===== */
function onPress(){
  if (
    document.getElementById('bootOverlay').classList.contains("show") ||
    document.getElementById('contextOverlay1').classList.contains("show") ||
    selectOverlay.classList.contains("show") ||
    lifeLostOverlay.classList.contains("show") ||
    gameOverOverlay.classList.contains("show") ||
    winOverlay.classList.contains("show") ||
    levelOverlay.classList.contains("show")
  ) return;

  const a=bgm(); if(a && a.paused){ playBGM(level,{reset:false}); }
  saltar();
}
function onKeyDown(e){
  const isSpace = e.code==="Space" || e.key===" " || e.keyCode===32;
  const isArrowUp = e.code==="ArrowUp" || e.keyCode===38;
  const isC = (e.code==='KeyC' || e.key?.toLowerCase()==='c');
  const isEnter = e.code==='Enter';
  const isS = (e.key?.toLowerCase()==='s');

  // BOOT
  if(document.getElementById('bootOverlay').classList.contains('show')){
    if(isC){ e.preventDefault(); insertCoin(); refreshBootCoins(); return; }
    if(isEnter||isSpace){ e.preventDefault(); showContext1(); return; }
  }
  // CONTEXTO (√∫nico)
  if(document.getElementById('contextOverlay1').classList.contains('show')){
    if(isC){ e.preventDefault(); insertCoin(); refreshBootCoins(); return; }
    if(isS){ e.preventDefault(); showSelect(); return; }
    if(isEnter||isSpace){ e.preventDefault(); showSelect(); return; }
  }
  // SELECT
  if(selectOverlay.classList.contains('show')){
    if(isC){ e.preventDefault(); insertCoin(); refreshBootCoins(); return; }
    if(isEnter||isSpace){ e.preventDefault(); document.getElementById('startDefault').click(); return; }
  }
  // Game Over: C = Insert Coin
  if(gameOverOverlay.classList.contains('show') && isC){
    e.preventDefault();
    insertCoin();
    tryAutoContinue();
    return;
  }

  if(isSpace||isArrowUp){ e.preventDefault(); onPress(); }
}

/* ===== F√çSICA ===== */
function saltar(){ if(dinoPosY===sueloY){ saltando=true; velY=impulso; dino.classList.remove("dino-corriendo"); } }
function moverDinosaurio(){ dinoPosY += velY * deltaTime; if(dinoPosY<sueloY) tocarSuelo(); dino.style.bottom = dinoPosY + "px"; }
function tocarSuelo(){ dinoPosY=sueloY; velY=0; if(saltando) dino.classList.add("dino-corriendo"); saltando=false; }
function moverSuelo(){ sueloX += velEscenarioBase * deltaTime * gameVel; suelo.style.left = -(sueloX % contenedor.clientWidth) + "px"; }

/* ===== SPAWN ===== */
function decidirCrearObstaculos(){ tiempoHastaObstaculo -= deltaTime; if(tiempoHastaObstaculo<=0) crearObstaculo(); }
function decidirCrearNubes(){ tiempoNubeVar -= deltaTime; if(tiempoNubeVar<=0) crearNube(); }
function crearObstaculo(){
  const o=document.createElement("div");
  contenedor.appendChild(o);
  o.classList.add("cactus");
  if(Math.random()>0.5) o.classList.add("cactus2");
  o.posX=contenedor.clientWidth;
  o.style.left=contenedor.clientWidth+"px";
  obstaculos.push(o);
  tiempoHastaObstaculo = tiempoObstaculoMin + Math.random()*(tiempoObstaculoMax-tiempoObstaculoMin)/gameVel;
}
function crearNube(){
  const n=document.createElement("div");
  contenedor.appendChild(n);
  n.classList.add("nube");
  n.posX=contenedor.clientWidth;
  n.style.left=contenedor.clientWidth+"px";
  n.style.bottom=(minNubeY + Math.random()*(maxNubeY-minNubeY))+"px";
  nubes.push(n);
  tiempoNubeVar = tiempoNubeMin + Math.random()*(tiempoNubeMax-tiempoNubeMin)/gameVel;
}

/* ===== MOVE ===== */
function moverObstaculos(){
  for(let i=obstaculos.length-1;i>=0;i--){
    if(obstaculos[i].posX < -obstaculos[i].clientWidth){
      obstaculos[i].remove(); obstaculos.splice(i,1); ganarPuntos();
    }else{
      obstaculos[i].posX -= velEscenarioBase * deltaTime * gameVel;
      obstaculos[i].style.left = obstaculos[i].posX + "px";
    }
  }
}
function moverNubes(){
  for(let i=nubes.length-1;i>=0;i--){
    if(nubes[i].posX < -nubes[i].clientWidth){
      nubes[i].remove(); nubes.splice(i,1);
    }else{
      nubes[i].posX -= velEscenarioBase * deltaTime * gameVel * velNube;
      nubes[i].style.left = nubes[i].posX + "px";
    }
  }
}

/* ===== SCORE / DIFICULTAD ===== */
function ganarPuntos(){
  score++; textoScore.textContent = String(score).padStart(3,'0');
  if(level===1){
    if(score===5){ gameVel=1.5*levelSpeedFactor; contenedor.classList.add("mediodia"); }
    else if(score===10){ gameVel=2*levelSpeedFactor; contenedor.classList.add("tarde"); }
    else if(score===20){ gameVel=3*levelSpeedFactor; contenedor.classList.add("noche"); }
  }
  suelo.style.animationDuration=(3/gameVel)+"s";
}

/* ===== COLISI√ìN / VIDAS ===== */
function detectarColision(){
  if(performance.now() < invulnerableUntil) return;
  for(let i=0;i<obstaculos.length;i++){
    if(obstaculos[i].posX > dinoPosX + dino.clientWidth) break;
    if(isCollision(dino,obstaculos[i],10,30,15,20)){ onDeath(); break; }
  }
}
function onDeath(){
  dino.classList.remove("dino-corriendo");
  dino.classList.add("dino-estrellado");
  parado = true;
  deathY = dinoPosY;
  const s=document.getElementById('hit-sfx'); if(s){ s.currentTime=0; s.play().catch(()=>{}); }
  lives--; renderLives();
  if(lives<=0){ showGameOver(); } else { lifeLostOverlay.classList.add("show"); }
}
function resumeAfterDeath(){
  lifeLostOverlay.classList.remove("show");
  clearStageButKeepScore();
  dino.classList.remove("dino-estrellado");
  dino.classList.add("dino-corriendo");
  dinoPosY=sueloY; velY=0; parado=false;
  const a=bgm(); if(a && a.paused){ playBGM(level,{reset:false}); }
}
function clearStageButKeepScore(){ obstaculos.forEach(o=>o.remove()); obstaculos=[]; nubes.forEach(n=>n.remove()); }

/* ===== GAME OVER ===== */
function showGameOver(){
  gameOverOverlay.classList.add("show");
  parado = true;
  pendingChoiceAnimal = null;

  const rb = document.getElementById('restartBtn');
  const ic = document.getElementById('insertCoinBtn');
  if(rb){ rb.style.display = 'inline-block'; rb.disabled = (credits <= 0); }
  if(ic){ ic.style.display = 'inline-block'; }

  hideMiniSelect();
  startCountdown();
}

function onRestartChoose(){
  if(credits <= 0) return;    // no dejar reiniciar sin coins
  stopCountdown();
  showMiniSelect();
  const rb = document.getElementById('restartBtn');
  if(rb) rb.style.display = 'none';
  updateGOUI();
}

function tryAutoContinue(){
  if(!gameOverOverlay.classList.contains('show')) return;
  if(!pendingChoiceAnimal || credits<=0) return;

  credits--; updateCredits(); refreshBootCoins();
  stopCountdown();

  selectedAnimal = pendingChoiceAnimal;
  applyCharacter();

  gameOverOverlay.classList.remove('show');
  hideMiniSelect();

  lives = CREDIT_LIVES; renderLives();

  dino.classList.remove("dino-estrellado"); 
  dino.classList.add("dino-corriendo");
  dinoPosY = Math.max(sueloY, Math.min(deathY, 200)); 
  velY = 0;
  invulnerableUntil = performance.now() + 1000;

  parado = false;
  const a=bgm(); if(a && a.paused){ playBGM(level,{reset:false}); }
}

function startCountdown(){
  stopCountdown(); countdown = 10; updateCountdown();
  countdownId = setInterval(()=>{
    countdown--; updateCountdown();
    if(countdown<=0){
      stopCountdown();
      if(gameOverOverlay.classList.contains('show')) backToBoot();
    }
  },1000);
}
function stopCountdown(){ if(countdownId){ clearInterval(countdownId); countdownId=null; } }
function updateCountdown(){
  const el=document.getElementById('countdown'); if(!el) return;
  el.textContent = String(countdown);
  el.style.color = countdown <= 3 ? '#ff3b3b' : '#ffe46b';
}

/* ===== COINS ===== */
function insertCoin(){
  credits++;
  updateCredits();
  refreshBootCoins();
  if (gameOverOverlay.classList.contains('show')) {
    updateGOUI(); // habilita RESTART si corresponde
  }
}

function updateCredits(){
  const hud = document.getElementById('coinsHud');
  if(hud) hud.textContent = String(credits);
  updateGOUI();
}
function refreshBootCoins(){ const b=document.getElementById('coinsBoot'); if(b) b.textContent=String(credits); }

/* ===== MINI SELECTOR ===== */
function showMiniSelect(){
  if(livesHud) livesHud.style.display='none';
  const mini=document.getElementById('miniSelect'); mini.classList.add('show');
}
function hideMiniSelect(){
  const mini=document.getElementById('miniSelect'); mini.classList.remove('show');
  if(livesHud) livesHud.style.display='flex';
}
function chooseMini(animal){
  pendingChoiceAnimal = animal || selectedAnimal;

  document.querySelectorAll('#miniSelect .mini-btn')
    .forEach(b=>b.classList.toggle('selected', b.dataset.mini === pendingChoiceAnimal));

  const goVisible   = gameOverOverlay.classList.contains('show');
  const miniVisible = document.getElementById('miniSelect').classList.contains('show');

  if(goVisible && miniVisible && credits > 0){
    credits--; updateCredits(); refreshBootCoins();

    selectedAnimal = pendingChoiceAnimal;
    applyCharacter();

    gameOverOverlay.classList.remove('show');
    hideMiniSelect();

    lives = CREDIT_LIVES; renderLives();

    dino.classList.remove("dino-estrellado");
    dino.classList.add("dino-corriendo");
    dinoPosY = Math.max(sueloY, Math.min(deathY, 200));
    velY = 0;
    invulnerableUntil = performance.now() + 1000;

    parado = false;
    const a=bgm(); if(a && a.paused){ playBGM(level,{reset:false}); }
  }else{
    updateGOUI();
  }
}

// === GO UI helper: habilitar/deshabilitar RESTART seg√∫n coins ===
function updateGOUI(){
  const goVisible = gameOverOverlay && gameOverOverlay.classList.contains('show');
  const restartBtn = document.getElementById('restartBtn');
  const insertBtn  = document.getElementById('insertCoinBtn');
  if(!goVisible || !restartBtn || !insertBtn) return;

  restartBtn.disabled = (credits <= 0);
  insertBtn.style.display = 'inline-block';
}

/* ===== VICTORIA ===== */
function onWin(){ winOverlay.classList.add('show'); parado=true; }

/* ===== RENDER VIDAS ===== */
function renderLives(){
  livesHud.innerHTML="";
  const frames=['heart-1','heart-2','heart-3'];
  for(let i=0;i<MAX_LIVES;i++){
    const span=document.createElement('span');
    span.className='life '+frames[i]+(i<lives?'':' lost');
    livesHud.appendChild(span);
  }
}

/* ===== NIVELES ===== */
function showLevelBanner(text){
  levelLabel.textContent=text;
  levelOverlay.classList.add('show');
  const prevParado = parado;
  parado = true;
  setTimeout(()=>{ levelOverlay.classList.remove('show'); parado = prevParado; }, 1300);
}

function toLevel2(){
  level=2; levelSpeedFactor = 1.6;
  contenedor.classList.add('level-2'); contenedor.classList.remove('mediodia','tarde','noche');
  document.getElementById('ufoLayer').style.display='block';
  const ufoImg = document.querySelector('#ufoLayer img'); if(ufoImg){ ufoImg.src = 'img/ufo2.gif?t=' + Date.now(); }
  stopStorm(); resetAll(false);
  score = 0; textoScore.textContent = "000"; gameVel = 1.8 * levelSpeedFactor;
  showLevelBanner('NIVEL 2'); playBGM(2,{reset:true});
}

function toLevel3(){
  level = 3; levelSpeedFactor = 2.0;
  contenedor.classList.add('level-3'); contenedor.classList.remove('level-2');
  document.getElementById('ufoLayer').style.display='none';
  startStorm(); resetAll(false);
  score = 0; textoScore.textContent = "000"; gameVel = 2.2 * levelSpeedFactor;
  showLevelBanner('NIVEL 3'); playBGM(3,{reset:true});
}

/* ===== TORMENTA ===== */
let lightningTimer=null;
function startStorm(){
  rainLayer.innerHTML='';
  const W = contenedor.clientWidth, dropCount = 120;
  for(let i=0;i<dropCount;i++){
    const d = document.createElement('div'); d.className='drop';
    const left = Math.random()*W, delay = Math.random()*1000, dur = 800 + Math.random()*900;
    d.style.left = left+'px'; d.style.animationDuration = dur+'ms'; d.style.animationDelay = delay+'ms';
    rainLayer.appendChild(d);
  }
  lightningLayer.innerHTML=''; clearInterval(lightningTimer);
  lightningTimer = setInterval(()=>{ if(Math.random()<0.35){ const f=document.createElement('div'); f.className='flash'; lightningLayer.appendChild(f); setTimeout(()=>f.remove(),320);} }, 600);
}
function stopStorm(){ rainLayer.innerHTML=''; lightningLayer.innerHTML=''; clearInterval(lightningTimer); lightningTimer=null; }

/* ===== UTIL ===== */
function isCollision(a,b,padT,padR,padB,padL){
  const ar=a.getBoundingClientRect(), br=b.getBoundingClientRect();
  return !(
    ((ar.top + ar.height - padB) < br.top) ||
    (ar.top + padT > (br.top + br.height)) ||
    ((ar.left + ar.width - padR) < br.left) ||
    (ar.left + padL > (br.left + br.width))
  );
}

function forceAutoplayVideos(root = document) {
  const vids = root.querySelectorAll('video.ctxvid');
  vids.forEach(v => {
    v.muted = true;
    v.playsInline = true;
    // intenta reproducir y vuelve a intentar si falla por pol√≠tica
    const tryPlay = () => v.play().catch(() => {});
    tryPlay();
    v.addEventListener('loadeddata', tryPlay, { once:true });
  });

  // En m√≥viles: un toque global vuelve a activar
  const tapResume = () => { vids.forEach(v => v.play().catch(()=>{})); };
  window.addEventListener('touchstart', tapResume, { passive:true, once:true });
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) vids.forEach(v => v.play().catch(()=>{}));
  });
}

/* Cuando abr√≠s la pantalla de contexto, forzamos autoplay */
function showContext1(){
  document.getElementById('bootOverlay').classList.remove("show");
  const ctx = document.getElementById('contextOverlay1');
  ctx.classList.add("show");
  // aseguro reproducci√≥n
  forceAutoplayVideos(ctx);
}

/* Mostrar pantalla inicial al cargar */
showBoot();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
